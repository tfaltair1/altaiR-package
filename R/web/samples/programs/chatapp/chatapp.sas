%MACRO testForUsername;
	%IF ~%SYMEXIST(SAVE_username) %THEN %DO;
		DATA _NULL_;
			FILE _WEBOUT;
			PUT "<html>";
			PUT " <head>";
			PUT "  <meta http-equiv=""refresh"" content=""0;URL=&_THISSRV" '&_program=ca.login.sas' """ />";
			PUT " </head>";
			PUT "<body>";
			PUT "<h1>Error: login required</h1>";
			PUT "  <a href=""&_THISSESSION" '&_program=ca.login.sas' """>Click here if your browser does not redirect</a>";
			PUT "</body>";
		RUN;
		ENDSAS;
	%END;
%MEND;
%testForUsername;

DATA _NULL_;
	FILE _WEBOUT;
	PUT "<html>";
	PUT "<body>";
	PUT "<h2>WPS Web Chat</h2>";
	PUT "<p>Login: &SAVE_username</p>";
RUN;

%MACRO showMessages;
  %IF %sysfunc(exist(APSWORK.messages)) %THEN %DO;
	PROC SQL;
		SELECT MAX(monotonic()) INTO:MAX_ROWS FROM APSWORK.messages;
		QUIT;
	RUN;
	ODS HTML BODY=_WEBOUT (TITLE="WPS Web Chat App");

	PROC SQL;
		SELECT user, msg, date_time,  monotonic() AS id FROM APSWORK.messages WHERE id > &MAX_ROWS - 10;
		QUIT;
	RUN;

	ODS HTML CLOSE;
 	DATA _NULL_;
		FILE _WEBOUT;
		PUT "<h3>&MAX_ROWS messages</h3>";
	RUN;
 %END;
 %ELSE %DO;
 	DATA _NULL_;
		FILE _WEBOUT;
		PUT "<h3>No messages</h3>";
	RUN;
 %END;
%MEND;
%showMessages;

DATA _NULL_;
	FILE _WEBOUT;
	PUT "<style>";
	PUT "body {";
	PUT " width: 1024px;";
	PUT " }";
	PUT "</style>";
	PUT "<a href=""&_THISSESSION" '&_program=ca.chatapp.sas' """>Refresh</a>";
	PUT "<form METHOD=""POST"" ACTION=""/wpscgi/broker.exe"">";
	PUT "<input type=""hidden"" name=""_SERVICE"" value=""&_SERVICE"" />";
	PUT "<input type=""hidden"" name=""_PORT"" value=""&_PORT"" />";
	PUT "<input type=""hidden"" name=""_SERVER"" value=""&_SERVER"" />";
	PUT "<input type=""hidden"" name=""_PROGRAM"" value=""ca.submitmessage.sas"" />";
	PUT "<input type=""hidden"" name=""_SESSIONID"" value=""&_SESSIONID"" />";
	PUT "<h4>Message:</h4>";
	PUT "<input type=""text"" name=""msg"" value="""" size=""160""/>";
	PUT "<br />";
	PUT "<input type=""submit"" name=""submit"" value=""Submit"" />";
	PUT "</form>";
RUN;
